#!/bin/bash
#
# cv_findCvMountdports.sh by cenobyte 28/05/2009
#
# use this script to find the CvMountd TCP port as a non privileged user.

cvsession="/tmp/cvsession.log"
cvsessionlock="/tmp/cvsession.log.lock"
netcat="/usr/bin/nc"
netstat="/bin/netstat"

for executable in $netcat $netstat; do
	if [ ! -x $executable ]; then
		echo "error: cannot execute $executable"
		exit 1
	fi
done

if [ -f $cvses ]; then
	for file in $cvsession $cvsessionlock; do
		rm -f $file > /dev/null 2>&1
		if [ $? -ne 0 ]; then
			echo "error: cannot delete $file"
			exit 1
		fi
	done
fi

touch $cvsession $cvsessionlock

for port in $($netstat -an | \
    awk '{ if ($1 == "tcp" && $6 == "LISTEN") print $4 }'); do
	checkport=${port##*:}

	if [ $checkport -gt 1024 ]; then
		echo 0 | $netcat localhost $checkport > /dev/null 2>&1
		if [ $(stat --format "%s" $cvsession) -gt 0 ]; then
			echo "CvMountd port: $checkport"
			rm -f $cvsession cvsessionlock
			exit 0
		fi
	fi
done

echo "error: could not determine CvMountd port"
exit 1
